LABS344_CONTAINER_BASE_IMAGE ?= docker.io/almalinux/9-base:9.6
LABS344_CONTAINER_IMAGE_REGISTRY ?= localhost
LABS344_CONTAINER_IMAGE_REGISTRY_REMOTE ?= ghcr.io/bouncmpe
LABS344_CONTAINER_IMAGE_NAME ?= labs344
LABS344_CONTAINER_TARGET_VERSION ?= latest
LABS344_CONTAINER_CURRENT_VERSION ?= $(shell date +'%Y%m%d')

LABS344_CONTAINER_BUILD_CONTEXT ?= .

info:
	@echo "Container version: ${LABS344_CONTAINER_TARGET_VERSION}"
	@echo "Container current version: ${LABS344_CONTAINER_CURRENT_VERSION}"

builder:
	buildah build \
		-f labs344/Dockerfile \
		--build-arg LABS344_CONTAINER_BASE_IMAGE=${LABS344_CONTAINER_BASE_IMAGE} \
		--build-arg LABS344_CONTAINER_VERSION=${LABS344_CONTAINER_CURRENT_VERSION} \
		--format oci \
		--layers=true \
		--target labs344-builder \
		--tag ${LABS344_CONTAINER_IMAGE_REGISTRY}/${LABS344_CONTAINER_IMAGE_NAME}:${LABS344_CONTAINER_TARGET_VERSION}-builder \
		--tag ${LABS344_CONTAINER_IMAGE_REGISTRY}/${LABS344_CONTAINER_IMAGE_NAME}:${LABS344_CONTAINER_CURRENT_VERSION}-builder \
		--tag ${LABS344_CONTAINER_IMAGE_REGISTRY_REMOTE}/${LABS344_CONTAINER_IMAGE_NAME}:${LABS344_CONTAINER_TARGET_VERSION}-builder \
		--tag ${LABS344_CONTAINER_IMAGE_REGISTRY_REMOTE}/${LABS344_CONTAINER_IMAGE_NAME}:${LABS344_CONTAINER_CURRENT_VERSION}-builder \
	${LABS344_CONTAINER_BUILD_CONTEXT}

devel: builder
	buildah build \
		-f labs344/Dockerfile \
		--build-arg LABS344_CONTAINER_BASE_IMAGE=${LABS344_CONTAINER_BASE_IMAGE} \
		--build-arg LABS344_CONTAINER_VERSION=${LABS344_CONTAINER_CURRENT_VERSION} \
		--format oci \
		--layers=true \
		--target labs344-devel \
		--tag ${LABS344_CONTAINER_IMAGE_REGISTRY}/${LABS344_CONTAINER_IMAGE_NAME}:${LABS344_CONTAINER_TARGET_VERSION}-devel \
		--tag ${LABS344_CONTAINER_IMAGE_REGISTRY}/${LABS344_CONTAINER_IMAGE_NAME}:${LABS344_CONTAINER_CURRENT_VERSION}-devel \
		--tag ${LABS344_CONTAINER_IMAGE_REGISTRY_REMOTE}/${LABS344_CONTAINER_IMAGE_NAME}:${LABS344_CONTAINER_TARGET_VERSION}-devel \
		--tag ${LABS344_CONTAINER_IMAGE_REGISTRY_REMOTE}/${LABS344_CONTAINER_IMAGE_NAME}:${LABS344_CONTAINER_CURRENT_VERSION}-devel \
	${LABS344_CONTAINER_BUILD_CONTEXT}
